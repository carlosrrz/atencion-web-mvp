<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Evaluación – Encargado</title>
  <link rel="stylesheet" href="./styles.css" />
  <style>
    .hidden{display:none !important;}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px;}
    header{background:#5ca2ff;color:#fff;padding:12px 16px;font-weight:700}
    table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid #eee;font-size:14px}
    .btn{background:#3b82f6;border:none;color:#fff;border-radius:8px;padding:6px 10px;cursor:pointer}
    .btn.out{background:#ef4444}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:12px 0}
    .pill{display:inline-block;border-radius:999px;padding:3px 10px;background:#eef}
    .ev{max-width:180px;border-radius:8px}
  </style>
</head>
<body>
<header>Proctoring – Encargado</header>
<div class="wrap">
  <div class="row">
    <button id="btn-export" class="btn">Exportar CSV</button>
    <button id="btn-logout" class="btn out">Salir</button>
    <span class="pill">Los datos se cargan del navegador (demo local).</span>
  </div>

  <table>
    <thead>
      <tr>
        <th>Fecha</th><th>Estudiante</th><th>Documento</th><th>Duración</th><th>Mirada</th><th>Off-tab</th><th>Habla</th><th>Evidencias</th><th>Ver</th>
      </tr>
    </thead>
    <tbody id="attempts-body"><tr><td colspan="9">Sin registros.</td></tr></tbody>
  </table>
</div>

<!-- Modal detalle -->
<div id="detail-bg" class="hidden" style="position:fixed;inset:0;background:#0008"></div>
<div id="detail" class="hidden" style="position:fixed;inset:5% 8%;background:#fff;border-radius:12px;padding:16px;overflow:auto">
  <h3>Detalle del intento</h3>
  <pre id="detail-json" style="white-space:pre-wrap;background:#f7f7f7;padding:10px;border-radius:8px"></pre>
  <div id="detail-evid" class="row"></div>
  <div class="row">
    <button id="btn-close" class="btn out">Cerrar</button>
  </div>
</div>

<script>
(function(){
  const ROLE_KEY='proctor.role.v1';
  const KEY='proctor.attempts.v1';

  // Restringir acceso
  try{ if(localStorage.getItem(ROLE_KEY)!=='encargado') location.href='./index.html'; }catch{}

  const tbody = document.getElementById('attempts-body');

  function fmt(ms){
    const s=Math.floor(ms/1000);const mm=String(Math.floor(s/60)).padStart(2,'0');const ss=String(s%60).padStart(2,'0');
    return `${mm}:${ss}`;
  }

  function load(){
    let list=[];
    try{ list = JSON.parse(localStorage.getItem(KEY)||'[]'); }catch{}
    if (!list.length){ tbody.innerHTML = '<tr><td colspan="9">Sin registros.</td></tr>'; return; }

    tbody.innerHTML='';
    list.sort((a,b)=>b.id-a.id).forEach((r,i)=>{
      const tr=document.createElement('tr');
      const s=r.summary||{};
      const st=r.student||{};
      const att=s.attention||{}, tab=s.tab_activity||{}, lips=s.lips||{};

      tr.innerHTML = `
        <td>${new Date(r.id).toLocaleString()}</td>
        <td>${(st.name||'—')}</td>
        <td>${(st.code||'—')}</td>
        <td>${fmt(s.duration_ms||0)}</td>
        <td>${att.lookaway_episodes||0} ep / ${fmt(att.lookaway_total_ms||0)}</td>
        <td>${tab.off_episodes||0} ep / ${fmt(tab.off_total_ms||0)}</td>
        <td>${lips.speak_episodes||0} ep / ${fmt(lips.speak_total_ms||0)}</td>
        <td>${(r.evidence||[]).length}</td>
        <td><button class="btn btn-view" data-i="${i}">Ver</button></td>
      `;
      tbody.appendChild(tr);
    });

    // listeners de "Ver"
    document.querySelectorAll('.btn-view').forEach(b=>{
      b.addEventListener('click', ()=>{
        const idx = Number(b.dataset.i);
        showDetail(list.sort((a,b)=>b.id-a.id)[idx]);
      });
    });
  }

  function showDetail(rec){
    document.getElementById('detail-json').textContent = JSON.stringify(rec.summary, null, 2);
    const cont = document.getElementById('detail-evid');
    cont.innerHTML='';
    (rec.evidence||[]).forEach(e=>{
      const img = document.createElement('img');
      img.src = e.data; img.alt=e.kind; img.className='ev';
      cont.appendChild(img);
    });
    document.getElementById('detail-bg').classList.remove('hidden');
    document.getElementById('detail').classList.remove('hidden');
  }

  document.getElementById('btn-close')?.addEventListener('click', ()=>{
    document.getElementById('detail-bg').classList.add('hidden');
    document.getElementById('detail').classList.add('hidden');
  });

  // Exportar CSV
  document.getElementById('btn-export')?.addEventListener('click', ()=>{
    let list=[];
    try{ list = JSON.parse(localStorage.getItem(KEY)||'[]'); }catch{}
    if(!list.length){ alert('No hay registros.'); return; }
    const rows=[['fecha','nombre','codigo','duracion','lookaway_ep','lookaway_ms','offtab_ep','offtab_ms','habla_ep','habla_ms','evidencias']];
    list.forEach(r=>{
      const s=r.summary||{}, st=r.student||{}, att=s.attention||{}, tab=s.tab_activity||{}, lips=s.lips||{};
      rows.push([
        new Date(r.id).toISOString(),
        st.name||'', st.code||'',
        s.duration_ms||0,
        att.lookaway_episodes||0, att.lookaway_total_ms||0,
        tab.off_episodes||0, tab.off_total_ms||0,
        lips.speak_episodes||0, lips.speak_total_ms||0,
        (r.evidence||[]).length
      ]);
    });
    const csv = rows.map(r=>r.join(',')).join('\n');
    const blob=new Blob([csv],{type:'text/csv'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='proctor_registros.csv'; a.click(); URL.revokeObjectURL(a.href);
  });

  // Salir
  document.getElementById('btn-logout')?.addEventListener('click', ()=>{
    try{ localStorage.removeItem(ROLE_KEY); }catch{}
    location.href='./index.html';
  });

  load();
})();
</script>
</body>
</html>
