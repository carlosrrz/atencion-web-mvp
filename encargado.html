<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel — Profesor</title>

  <!-- hoja principal (usa cache-buster opcional) -->
  <link rel="stylesheet" href="/src/styles.css?v=20251120"/>

  <style>
    .wrap{max-width:1200px;margin:20px auto;padding:0 16px}
    table{width:100%;border-collapse:separate;border-spacing:0 6px}
    th,td{padding:8px 10px;background:#fff0;border:1px solid var(--border)}
    th{background:#0f1b34;text-align:left;color:#e6edf7}
    td{background:#0c1428;color:#dfe7f6}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;padding:2px 8px;border-radius:999px;background:#0f1b34;border:1px solid var(--border);color:#cdd7ee}
    .pill-warn{background:#2a1a0f;border-color:#8a3; color:#e6f7d9}
    .muted{color:var(--muted);font-size:.92rem}

    /* Modal de detalle */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:300}
    .modal{position:fixed;left:50%;top:7%;transform:translateX(-50%);
      width:min(980px,94vw);background:#0b1324;border:1px solid var(--border);
      border-radius:14px;box-shadow:var(--shadow);display:none;z-index:301;color:#e6edf7}
    .modal header,.modal footer{padding:12px 16px;border-bottom:1px solid var(--border)}
    .modal footer{border-top:1px solid var(--border);border-bottom:none;display:flex;justify-content:flex-end;gap:8px}
    .modal .body{padding:14px}

    /* Grid de evidencias */
    .ev-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
    .ev-card{border:1px solid var(--border);border-radius:12px;padding:8px;background:#0b1324;box-shadow:0 2px 10px rgba(2,8,23,.12)}
    .ev-card img{width:100%;height:auto;border-radius:8px;display:block}
    .ev-note{font-size:.85rem;color:var(--muted);margin-top:6px}

    /* Tarjeta banco examen + botones básicos */
    .card{background:#0b1324;border:1px solid var(--border);border-radius:14px;padding:14px;margin:16px auto;color:#e6edf7}
    .auth-input{width:100%;height:48px;padding:10px 12px;border-radius:12px;border:1px solid #1c2a48;background:#0e1a2f;color:#e6edf7}
    .primary{height:44px;border:0;border-radius:12px;background:#2f6cf6;color:#fff;font-weight:600;padding:0 14px;cursor:pointer}
    .secondary{height:44px;border:1px solid #21365c;border-radius:12px;background:#0f1b34;color:#e6edf7;padding:0 12px;cursor:pointer}

    /* Toast */
    .toast{position:fixed;right:16px;bottom:16px;background:#0b1324;color:#e6edf7;
      border:1px solid #21365c;border-radius:12px;padding:12px 14px;box-shadow:0 10px 30px rgba(2,8,23,.4);
      display:none;z-index:400}
    .toast.ok{border-color:#2e7d32}
    .toast.err{border-color:#b3261e}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="wrap row" style="justify-content:space-between">
      <h1>Panel del profesor</h1>
      <nav class="row">
        <button id="btn-logout" class="secondary" type="button">Salir</button>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <div class="row" style="justify-content:space-between;margin-bottom:10px">
      <div class="row">
        <button id="btn-export-all" class="secondary">Exportar CSV (todos)</button>
        <button id="btn-clear" class="secondary">Limpiar cache local</button>
      </div>
      <span class="pill" id="count-pill">0 intentos</span>
    </div>

    <table id="tbl">
      <thead>
        <tr>
          <th>#</th>
          <th>Alumno</th>
          <th>Código</th>
          <th>Inicio</th>
          <th>Fin</th>
          <th>Duración</th>
          <th>Off-tab (episodios)</th>
          <th>Mirada (episodios)</th>
          <th>Habla (episodios)</th>
          <th>Examen</th>
          <th>Ver</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <!-- Banco de examen -->
  <section class="card" style="max-width:1200px">
    <h3>Banco de examen (CSV/JSON)</h3>
    <div class="row" style="flex-direction:column;gap:10px">
      <input id="exam-name" class="auth-input" placeholder="Nombre del examen" />
      <input id="exam-file" type="file" accept=".json,.csv" class="auth-input" />
      <button id="exam-upload" class="primary" style="align-self:flex-start">Cargar y activar</button>
    </div>
  </section>

  <!-- Modal detalle -->
  <div id="backdrop" class="backdrop" aria-hidden="true"></div>
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="m-title">
    <header>
      <div class="row" style="justify-content:space-between">
        <strong id="m-title">Detalle</strong>
        <button id="m-close" class="secondary">Cerrar</button>
      </div>
    </header>
    <div class="body" id="m-body">—</div>
    <footer>
      <button id="m-export" class="secondary">Exportar CSV (intento)</button>
    </footer>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <script type="module">
    import { requireRole, clearSession } from './src/roles.js';
    requireRole('prof');

    const $ = (s)=>document.querySelector(s);

    // ---- UI refs
    const tblBody   = $('#tbl tbody');
    const countPill = $('#count-pill');
    const btnAll    = $('#btn-export-all');
    const btnClr    = $('#btn-clear');
    const btnLogout = $('#btn-logout');

    const backdrop  = $('#backdrop');
    const modal     = $('#modal');
    const mTitle    = $('#m-title');
    const mBody     = $('#m-body');
    const mClose    = $('#m-close');
    const mExport   = $('#m-export');
    const toast     = $('#toast');

    // ---- utils
    const fmtTime = (ms)=>{ const s=Math.floor((ms||0)/1000); const mm=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${mm}:${ss}`; };
    const fmt     = (ts)=>{ try{ return new Date(ts).toLocaleString(); }catch{ return '—'; } };
    const safe    = (v)=> (v==null || v==='') ? '—' : String(v);

    function showToast(msg, ok=true){
      toast.textContent = msg;
      toast.classList.remove('ok','err');
      toast.classList.add(ok ? 'ok' : 'err');
      toast.style.display = 'block';
      setTimeout(()=>{ toast.style.display='none'; }, 2400);
    }

    // ---- data
    let DATA = [];
    let CURRENT = null;

    async function fetchAttemptsFromCloud() {
      const r = await fetch('/api/attempt/list?limit=200', { cache: 'no-store' });
      const j = await r.json(); // si viene HTML fallará y lo atrapamos arriba
      if (!r.ok || !j.ok) throw new Error(j.error || 'No se pudo cargar intentos');
      return j.items || [];
    }

    // ↓ Nuevo: trae el intento completo (incluye evidences) por ID
async function fetchAttemptFull(id){
  const r = await fetch(`/api/attempt/get?id=${encodeURIComponent(id)}`, { cache:'no-store' });
  let j; try { j = await r.json(); } catch { throw new Error('Respuesta no JSON'); }
  if (!r.ok || !j.ok) throw new Error(j.error || 'No se pudo cargar el detalle');
  return j.item;
}


    function render(items){
      DATA = items;
      countPill.textContent = `${items.length} intento${items.length===1?'':'s'}`;
      tblBody.innerHTML = items.map((a,i)=>{
        const off   = a.summary?.off_episodes ?? a.summary?.tab_activity?.off_episodes ?? 0;
        const look  = a.summary?.lookaway_episodes ?? a.summary?.attention?.lookaway_episodes ?? 0;
        const speak = a.summary?.speak_episodes ?? a.summary?.lips?.speak_episodes ?? 0;
        const ex = a.exam || {};
        const examTxt =
          (ex.score   != null && ex.total != null) ? `${ex.score}/${ex.total}` :
          (ex.correct != null && ex.total != null) ? `${ex.correct}/${ex.total}` :
          '—';

        return `
          <tr>
            <td>${i+1}</td>
            <td>${safe(a.student?.name)}</td>
            <td>${safe(a.student?.code)}</td>
            <td>${fmt(a.startedAt)}</td>
            <td>${fmt(a.endedAt)}</td>
            <td>${fmtTime(a.durationMs||0)}</td>
            <td>${off}</td>
            <td>${look}</td>
            <td>${speak}</td>
            <td>${examTxt}</td>
            <td><button class="secondary" data-id="${a.id}">Ver</button></td>
          </tr>`;
      }).join('');
    }

    async function loadAndRender(){
      try{
        const items = await fetchAttemptsFromCloud();
        render(items);
      }catch(e){
        console.error(e);
        showToast('No se pudieron cargar los intentos', false);
        render([]);
      }
    }

    // ---- detalle + evidencias
    const srcOf = (it) => it?.data || it?.image_base64 || it?.image || it?.img || it?.url || '';

    function findAttempt(id){ return DATA.find(x => String(x.id) === String(id)); }

async function openDetail(id){
  // 1) base: lo que ya tienes en memoria
  let a = DATA.find(x => String(x.id) === String(id));
  if (!a) return;

  // 2) carga el detalle (con evidences)
  try {
    const r = await fetch(`/api/attempt/get?id=${encodeURIComponent(a.id)}`, { cache: 'no-store' });
    const j = await r.json();
    if (r.ok && j.ok && j.item) a = { ...a, ...j.item };
  } catch (e) {
    console.warn('[detail] fallback sin evidences', e);
  }

  const off   = a.summary?.tab_activity?.off_episodes ?? a.summary?.off_episodes ?? 0;
  const look  = a.summary?.attention?.lookaway_episodes ?? a.summary?.lookaway_episodes ?? 0;
  const speak = a.summary?.lips?.speak_episodes ?? a.summary?.speak_episodes ?? 0;

  const ex = a.exam || {};
  const examTxt =
    (ex.score   != null && ex.total != null) ? `${ex.score}/${ex.total}` :
    (ex.correct != null && ex.total != null) ? `${ex.correct}/${ex.total}` :
    '—';

  const srcOf = (it) =>
    it?.data || it?.image_base64 || it?.image || it?.img || it?.url || '';

  const evid = Array.isArray(a.evidences) ? a.evidences
             : (Array.isArray(a.evidence) ? a.evidence : []);

  mTitle.textContent = `Intento ${a.id} — ${a.student?.name || ''}`;
  mBody.innerHTML = `
    <div class="row" style="margin-bottom:8px">
      <span class="pill">Inicio: ${fmt(a.startedAt)}</span>
      <span class="pill">Fin: ${fmt(a.endedAt)}</span>
      <span class="pill">Duración: ${fmtTime(a.durationMs||0)}</span>
      <span class="pill">Examen: ${examTxt}</span>
    </div>

    <h4>Resumen</h4>
    <ul>
      <li>Off-tab (episodios): ${off}</li>
      <li>Mirada desviada (episodios): ${look}</li>
      <li>Posible habla (episodios): ${speak}</li>
    </ul>

    <h4>Evidencias</h4>
    <div class="ev-grid">
      ${
        evid?.length
          ? evid.map(it => {
              const src = srcOf(it);
              return `
                <div class="ev-card">
                  <div class="pill pill-warn">${it.kind || 'alerta'}</div>
                  ${src ? `<img src="${src}" alt="${it.kind||'evidencia'}" />`
                        : `<div class="muted">Sin imagen adjunta</div>`}
                  <div class="ev-note">
                    ${new Date(it.t || it.taken_at || Date.now()).toLocaleTimeString()}
                    — ${it.note || ''}
                  </div>
                </div>`;
            }).join('')
          : '<div class="muted">No hay evidencias capturadas.</div>'
      }
    </div>
  `;
  backdrop.style.display = 'block';
  modal.style.display = 'block';
}


// Delegación clicks en tabla (déjalo así)
tblBody.addEventListener('click', (e)=>{
  const btn = e.target.closest('button');
  if (!btn) return;
  const id = btn.dataset.id;
  if (id) openDetail(id);
});



    // Delegación click en tabla
    tblBody.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-id]');
      if (!btn) return;
      openDetail(btn.dataset.id);
    });

    // Cerrar modal
    mClose.addEventListener('click', ()=>{ backdrop.style.display='none'; modal.style.display='none'; CURRENT=null; });
    backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop){ backdrop.style.display='none'; modal.style.display='none'; CURRENT=null; }});

    // Exportar CSV (todos)
    function toCSV(rows, headers){
      const esc = v => `"${String(v??'').replaceAll('"','""')}"`;
      const head = headers.map(esc).join(',');
      const body = rows.map(r => headers.map(h => esc(r[h])).join(',')).join('\n');
      return head + '\n' + body;
    }

    btnAll.addEventListener('click', ()=>{
      if(!DATA.length){ showToast('No hay intentos', false); return; }
      const rows = DATA.map(a=>({
        id: a.id,
        nombre: a.student?.name ?? '',
        codigo: a.student?.code ?? '',
        inicio: fmt(a.startedAt),
        fin: fmt(a.endedAt),
        duracion: fmtTime(a.durationMs||0),
        off_tab_ep: a.summary?.off_episodes ?? a.summary?.tab_activity?.off_episodes ?? 0,
        mirada_ep:  a.summary?.lookaway_episodes ?? a.summary?.attention?.lookaway_episodes ?? 0,
        habla_ep:   a.summary?.speak_episodes ?? a.summary?.lips?.speak_episodes ?? 0,
        puntaje: (a.exam?.score ?? a.exam?.correct ?? ''),
        total:   (a.exam?.total ?? '')
      }));
      const csv = toCSV(rows, ['id','nombre','codigo','inicio','fin','duracion','off_tab_ep','mirada_ep','habla_ep','puntaje','total']);
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'intentos.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    // Exportar CSV (un intento)
    mExport.addEventListener('click', ()=>{
      const r = CURRENT;
      if(!r){ showToast('No encontrado', false); return; }
      const rows = [{
        id: r.id,
        nombre: r.student?.name ?? '',
        codigo: r.student?.code ?? '',
        inicio: fmt(r.startedAt),
        fin: fmt(r.endedAt),
        duracion: fmtTime(r.durationMs||0),
        off_tab_ep: r.summary?.off_episodes ?? r.summary?.tab_activity?.off_episodes ?? 0,
        mirada_ep:  r.summary?.lookaway_episodes ?? r.summary?.attention?.lookaway_episodes ?? 0,
        habla_ep:   r.summary?.speak_episodes ?? r.summary?.lips?.speak_episodes ?? 0,
        puntaje: (r.exam?.score ?? r.exam?.correct ?? ''),
        total:   (r.exam?.total ?? '')
      }];
      const csv = toCSV(rows, Object.keys(rows[0]));
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `intento_${r.id}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    });

    // Limpiar cache local (solo localStorage)
    btnClr.addEventListener('click', ()=>{
      try{ localStorage.removeItem('proctor.attempts'); showToast('Cache local limpiada'); }catch{}
    });

    // Subida de examen (CSV/JSON)
    async function parseFileToQuestions(file) {
      const text = await file.text();
      if (file.name.toLowerCase().endsWith('.json')) {
        const j = JSON.parse(text);
        const list = Array.isArray(j) ? j : (j.questions || []);
        return list.map((q, i) => ({
          id: q.id ?? `q_${i+1}`,
          text: q.text ?? '',
          options: (q.options ?? []).map(String),
          correct: Number(q.correct ?? 0)
        }));
      } else if (file.name.toLowerCase().endsWith('.csv')) {
        // CSV: id,text,o1,o2,o3,o4,correct
        const rows = text.trim().split(/\r?\n/).map(l => l.split(','));
        const hdr = rows.shift().map(h => h.trim().toLowerCase());
        const idx = (k) => hdr.indexOf(k);
        const out = [];
        for (const r of rows) {
          out.push({
            id: r[idx('id')] || '',
            text: r[idx('text')] || '',
            options: [r[idx('o1')], r[idx('o2')], r[idx('o3')], r[idx('o4')]].filter(Boolean),
            correct: Number(r[idx('correct')] || 0)
          });
        }
        return out;
      }
      throw new Error('Formato no soportado. Usa .json o .csv');
    }

    $('#exam-upload').addEventListener('click', async ()=>{
      const name = ($('#exam-name')?.value || 'Examen').trim();
      const file = $('#exam-file')?.files?.[0];
      if (!file) { showToast('Selecciona un archivo CSV/JSON', false); return; }

      try{
        const questions = await parseFileToQuestions(file);
        const r = await fetch('/api/exams/set', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ name, questions })
        });
        let j; try{ j = await r.json(); }catch{ throw new Error('Respuesta no JSON'); }
        if (!r.ok || !j.ok) throw new Error(j.error || 'Error guardando el examen');
        showToast(`Examen "${name}" activado (${j.saved} preguntas).`, true);
      }catch(e){
        console.error(e);
        showToast(e.message || 'Error guardando el examen', false);
      }
    });

    // Logout
    btnLogout.addEventListener('click', async (e)=>{
      e.preventDefault();
      try{ await fetch('/api/auth/logout', {method:'POST'}); }catch{}
      clearSession();
      location.replace('login.html');
    });

    // Go!
    loadAndRender();
  </script>
</body>
</html>
