<script type="module">
  import { requireRole } from './src/roles.js';
  requireRole(['prof']);
</script>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel â€” Profesor</title>
  <link rel="stylesheet" href="./src/styles.css" />

  <style>
    .wrap{max-width:1200px;margin:20px auto;padding:0 16px}
    table{width:100%;border-collapse:separate;border-spacing:0 6px}
    th,td{padding:8px 10px;background:#fff;border:1px solid var(--border)}
    th{background:#f8fafc;text-align:left}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;padding:2px 8px;border-radius:999px;background:#f3f4f6;border:1px solid var(--border)}
    .muted{color:var(--muted);font-size:.92rem}

    /* Modal sencillo (propio de esta pÃ¡gina) */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:300}
    .modal{position:fixed;left:50%;top:7%;transform:translateX(-50%);width:min(980px,94vw);background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);display:none;z-index:301}
    .modal header,.modal footer{padding:12px 16px;border-bottom:1px solid var(--border)}
    .modal footer{border-top:1px solid var(--border);border-bottom:none;display:flex;justify-content:flex-end;gap:8px}
    .modal .body{padding:14px}

    /* Grid de evidencias (usa nombres similares a tu styles.css) */
    .ev-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px}
    .ev-card{border:1px solid var(--border);border-radius:12px;padding:8px;background:#fff;box-shadow:0 2px 10px rgba(2,8,23,.05)}
    .ev-card img{width:100%;height:auto;border-radius:8px;display:block}
    .ev-note{font-size:.85rem;color:var(--muted);margin-top:6px}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="wrap row" style="justify-content:space-between">
      <h1>Panel del profesor</h1>
      <nav class="row">
        <a href="login.html" class="secondary">Salir</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <div class="row" style="justify-content:space-between;margin-bottom:10px">
      <div class="row">
        <button id="btn-export-all" class="secondary">Exportar CSV (todos)</button>
        <button id="btn-clear" class="secondary">Limpiar todo</button>
      </div>
      <span class="pill" id="count-pill">0 intentos</span>
    </div>

    <table id="tbl">
      <thead>
        <tr>
          <th>#</th>
          <th>Alumno</th>
          <th>CÃ³digo</th>
          <th>Inicio</th>
          <th>Fin</th>
          <th>DuraciÃ³n</th>
          <th>Off-tab (episodios)</th>
          <th>Mirada (episodios)</th>
          <th>Habla (episodios)</th>
          <th>Examen</th>
          <th>Ver</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <section class="card" style="margin-top:16px">
  <h3>Banco de examen (CSV/JSON)</h3>
  <input id="exam-title" class="auth-input" placeholder="Nombre del examen">
  <input id="exam-file" type="file" accept=".json,.csv">
  <!-- importante: type="button" para que no envÃ­e ningÃºn form -->
  <button id="exam-upload" class="primary" type="button">Cargar y activar</button>
</section>

<!-- Modal de Ã©xito -->
<div id="ok-backdrop" class="backdrop" aria-hidden="true" style="display:none"></div>
<div id="ok-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="ok-title" style="display:none">
  <header>
    <strong id="ok-title">Examen actualizado</strong>
  </header>
  <div class="body">
    <div style="display:flex;align-items:center;gap:12px">
      <div style="width:42px;height:42px;border-radius:999px;background:#16a34a;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700">âœ“</div>
      <div id="ok-msg">Se activÃ³ el examen correctamente.</div>
    </div>
  </div>
  <footer>
    <button id="ok-close" class="secondary">Cerrar</button>
  </footer>
</div>

<script type="module">
  const $ = s => document.querySelector(s);

  // --- Parsear archivo a {id,text,options[],correct} ---
  async function parseFileToQuestions(file) {
    const text = await file.text();

    if (file.name.toLowerCase().endsWith('.json')) {
      const j = JSON.parse(text);
      const list = Array.isArray(j) ? j : (j.questions || []);
      return list.map((q, i) => ({
        id: q.id ?? `q_${i+1}`,
        text: q.text ?? '',
        options: (q.options ?? []).map(String),
        correct: Number(q.correct ?? 0)
      }));
    }

    if (file.name.toLowerCase().endsWith('.csv')) {
      // CSV con cabecera: id,text,o1,o2,o3,o4,correct
      const rows = text.trim().split(/\r?\n/).map(l => l.split(','));
      const hdr = rows.shift().map(h => h.trim().toLowerCase());
      const idx = (k) => hdr.indexOf(k);
      const out = [];
      for (const r of rows) {
        out.push({
          id: r[idx('id')] || '',
          text: r[idx('text')] || '',
          options: [r[idx('o1')], r[idx('o2')], r[idx('o3')], r[idx('o4')]].filter(Boolean),
          correct: Number(r[idx('correct')] || 0)
        });
      }
      return out;
    }

    throw new Error('Formato no soportado. Usa .json o .csv');
  }

  // --- Modal Ã©xito ---
  const okBackdrop = $('#ok-backdrop');
  const okModal    = $('#ok-modal');
  const okMsg      = $('#ok-msg');
  const okClose    = $('#ok-close');

  function showOk(msg) {
    okMsg.textContent = msg || 'OperaciÃ³n realizada correctamente.';
    okBackdrop.style.display = 'block';
    okModal.style.display = 'block';
  }
  okClose.addEventListener('click', () => {
    okBackdrop.style.display = 'none';
    okModal.style.display = 'none';
  });
  okBackdrop.addEventListener('click', e => { if (e.target === okBackdrop) okClose.click(); });

  // --- Handler correcto con tus IDs: #exam-title / #exam-file / #exam-upload ---
  $('#exam-upload')?.addEventListener('click', async () => {
    const name = ($('#exam-title')?.value || 'Examen').trim();
    const file = $('#exam-file')?.files?.[0];
    if (!file) return alert('Selecciona un archivo CSV/JSON');

    try {
      const questions = await parseFileToQuestions(file);

      const r = await fetch('/api/exam/set', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, questions })
      });
      const j = await r.json();

      if (!r.ok || !j.ok) throw new Error(j.error || 'Error guardando el examen');

      // Limpio el file input para evitar confusiones
      $('#exam-file').value = '';
      showOk(`Examen "${name}" activado (${j.saved} preguntas).`);
    } catch (e) {
      console.error(e);
      alert(e.message || 'Error guardando el examen');
    }
  });
</script>




  <!-- Modal detalle -->
  <div id="backdrop" class="backdrop" aria-hidden="true"></div>
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="m-title">
    <header>
      <div class="row" style="justify-content:space-between">
        <strong id="m-title">Detalle</strong>
        <button id="m-close" class="secondary">Cerrar</button>
      </div>
    </header>
    <div class="body" id="m-body">â€”</div>
    <footer>
      <button id="m-export" class="secondary">Exportar CSV (intento)</button>
    </footer>
  </div>

  <script type="module">
    // ðŸ”— Ajusta estas rutas si tus mÃ³dulos estÃ¡n en otra carpeta
    import { requireRole } from './src/roles.js';
    import { loadAttempts, exportAllCSV, exportOneCSV, clearAll } from './src/store.js';

    requireRole('prof');

    const tblBody   = document.querySelector('#tbl tbody');
    const countPill = document.getElementById('count-pill');
    const btnAll    = document.getElementById('btn-export-all');
    const btnClr    = document.getElementById('btn-clear');

    const backdrop  = document.getElementById('backdrop');
    const modal     = document.getElementById('modal');
    const mTitle    = document.getElementById('m-title');
    const mBody     = document.getElementById('m-body');
    const mClose    = document.getElementById('m-close');
    const mExport   = document.getElementById('m-export');

    let current = null;

    const fmtTime = (ms)=>{ const s=Math.floor((ms||0)/1000); const mm=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${mm}:${ss}`; };
    const fmt     = (ts)=>{ try{ return new Date(ts).toLocaleString(); }catch{ return 'â€”'; } };
    const safe    = (v)=> (v==null || v==='') ? 'â€”' : String(v);

    function render(){
      const arr = loadAttempts(); // usa la misma KEY del store
      countPill.textContent = `${arr.length} intento${arr.length===1?'':'s'}`;

      tblBody.innerHTML = arr.map((a,i)=>{
        const s   = a.summary || {};
        const ta  = s.tab_activity || {};
        const att = s.attention     || {};
        const lip = s.lips          || {};
        const ex  = a.exam || {};
        // compatibilidad: exam.correct o exam.score
        const examTxt = (ex.correct!=null && ex.total!=null) ? `${ex.correct}/${ex.total}`
                       : (ex.score!=null && ex.total!=null)   ? `${ex.score}/${ex.total}` : 'â€”';

        return `
          <tr>
            <td>${i+1}</td>
            <td>${safe(a.student?.name)}</td>
            <td>${safe(a.student?.code)}</td>
            <td>${fmt(a.startedAt)}</td>
            <td>${fmt(a.endedAt)}</td>
            <td>${fmtTime(a.durationMs||0)}</td>
            <td>${ta.off_episodes ?? 0}</td>
            <td>${att.lookaway_episodes ?? 0}</td>
            <td>${lip.speak_episodes ?? 0}</td>
            <td>${examTxt}</td>
            <td><button class="secondary" data-id="${a.id}">Ver</button></td>
          </tr>`;
      }).join('');
    }

    function openDetail(id){
      const a = loadAttempts().find(x=>x.id===id);
      if(!a) return;
      current = a;

      const s   = a.summary || {};
      const ta  = s.tab_activity || {};
      const att = s.attention     || {};
      const occ = s.occlusion     || {};
      const lip = s.lips          || {};
      const perf= s.performance   || {};
      const ex  = a.exam          || {};
      const examTxt = (ex.correct!=null && ex.total!=null) ? `${ex.correct}/${ex.total}`
                     : (ex.score!=null && ex.total!=null)   ? `${ex.score}/${ex.total}` : 'â€”';

      // ðŸ‘‡ Evidencias: usa plural y SI NO existe, hace fallback al singular
      const evid = Array.isArray(a.evidences) ? a.evidences
                 : (Array.isArray(a.evidence) ? a.evidence : []);

      mTitle.textContent = `Intento ${a.id} â€” ${safe(a.student?.name)}`;
      mBody.innerHTML = `
        <div class="row" style="margin-bottom:8px">
          <span class="pill">Inicio: ${fmt(a.startedAt)}</span>
          <span class="pill">Fin: ${fmt(a.endedAt)}</span>
          <span class="pill">DuraciÃ³n: ${fmtTime(a.durationMs||0)}</span>
          <span class="pill">Examen: ${examTxt}</span>
        </div>

        <h4>Resumen</h4>
        <ul>
          <li>Off-tab (â‰¥ ${Math.round((ta.threshold_ms ?? ta.offThresholdMs ?? 1500)/1000)}s): ${ta.off_episodes ?? 0} Â· tiempo: ${fmtTime(ta.off_total_ms||0)}</li>
          <li>Mirada desviada: ${att.lookaway_episodes ?? 0} Â· tiempo: ${fmtTime(att.lookaway_total_ms||0)} Â· mÃ¡x: ${fmtTime(att.lookaway_longest_ms||0)}</li>
          <li>Rostro cubierto: ${occ.episodes ?? 0} Â· tiempo: ${fmtTime(occ.total_ms||0)}</li>
          <li>Posible habla: ${lip.speak_episodes ?? 0} Â· tiempo: ${fmtTime(lip.speak_total_ms||0)}</li>
          <li>Rendimiento: FPSâ‰ˆ${(perf.fps_median ?? 0)} Â· p95â‰ˆ${(perf.latency_p95_ms ?? 0)} ms</li>
        </ul>

        <h4>Evidencias</h4>
        <div class="ev-grid" id="ev-grid">
          ${
            evid.length
              ? evid.map(it => `
                  <div class="ev-card">
                    <div class="pill pill-warn">${it.kind||'alerta'}</div>
                    <img src="${it.data}" alt="${it.kind||'evidencia'}" />
                    <div class="ev-note">${new Date(it.t||Date.now()).toLocaleTimeString()} â€” ${it.note||''}</div>
                  </div>
                `).join('')
              : '<div class="muted">No hay evidencias capturadas.</div>'
          }
        </div>
      `;

      backdrop.style.display='block';
      modal.style.display='block';
    }

    // DelegaciÃ³n clicks en tabla
    tblBody.addEventListener('click', (e)=>{
      const btn = e.target.closest('button');
      if (!btn) return;
      const id = btn.dataset.id;
      if (id) openDetail(id);
    });

    // Controles modal / superiores
    mClose.addEventListener('click', ()=>{ backdrop.style.display='none'; modal.style.display='none'; current=null; });
    backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop){ backdrop.style.display='none'; modal.style.display='none'; current=null; }});
    mExport.addEventListener('click', ()=>{ if(current) exportOneCSV(current); });
    btnAll.addEventListener('click', ()=> exportAllCSV());
    btnClr.addEventListener('click', ()=>{
      if(!confirm('Â¿Borrar todos los intentos guardados en este navegador?')) return;
      clearAll(); render();
    });

    render();
  </script>
</body>
</html>
