<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Evaluación — Encargado</title>
  <link rel="stylesheet" href="./src/src/styles.css" />
</head>
<body>
  <header class="topbar">
    <div class="wrap">
      <h1>Panel del encargado</h1>
      <nav>
        <a href="index.html">Volver</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <div class="card" id="gate">
      <h2>Acceso</h2>
      <p>Ingresa el código:</p>
      <input id="admin-code" class="input" placeholder="Código" />
      <button id="btn-enter" class="btn btn-primary">Entrar</button>
      <p class="help">Este código es sólo para evitar accesos accidentales.</p>
    </div>

    <div class="card hidden" id="panel">
      <h2>Intentos registrados</h2>
      <div class="row">
        <button id="btn-export" class="btn btn-ghost">Exportar CSV</button>
        <button id="btn-clear"  class="btn btn-danger">Limpiar</button>
      </div>
      <table class="table" id="tbl">
        <thead>
          <tr><th>#</th><th>Inicio</th><th>Fin</th><th>Correctas</th><th>Total</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <script type="module">
    const ADMIN_CODE = '7777';

    const gate   = document.getElementById('gate');
    const panel  = document.getElementById('panel');
    const input  = document.getElementById('admin-code');
    const enter  = document.getElementById('btn-enter');
    const tbl    = document.getElementById('tbl').querySelector('tbody');
    const btnCSV = document.getElementById('btn-export');
    const btnClr = document.getElementById('btn-clear');

    const KEY = 'mvp.exam.attempts';

    function fmt(ts){
      try{ return new Date(ts).toLocaleString(); }catch{ return '—'; }
    }

    function load(){
      let arr = [];
      try{ arr = JSON.parse(localStorage.getItem(KEY) || '[]'); }catch{}
      tbl.innerHTML = arr.map((r,i)=>`
        <tr>
          <td>${i+1}</td>
          <td>${fmt(r.startedAt)}</td>
          <td>${fmt(r.finishedAt)}</td>
          <td>${r.correct}</td>
          <td>${r.total}</td>
        </tr>
      `).join('');
    }

    function toCSV(){
      let arr = [];
      try{ arr = JSON.parse(localStorage.getItem(KEY) || '[]'); }catch{}
      const rows = [['#','inicio','fin','correctas','total']];
      arr.forEach((r,i)=> rows.push([i+1, fmt(r.startedAt), fmt(r.finishedAt), r.correct, r.total]));
      const csv = rows.map(r=>r.join(',')).join('\n');
      const blob = new Blob([csv], { type:'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'intentos.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    enter.addEventListener('click', ()=>{
      if (input.value.trim() !== ADMIN_CODE){ alert('Código incorrecto'); return; }
      gate.classList.add('hidden');
      panel.classList.remove('hidden');
      load();
    });

    btnCSV.addEventListener('click', toCSV);
    btnClr.addEventListener('click', ()=>{
      if (!confirm('¿Borrar todos los intentos guardados en este navegador?')) return;
      localStorage.removeItem(KEY);
      load();
    });
  </script>
</body>
</html>
