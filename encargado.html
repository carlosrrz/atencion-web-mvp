<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel ‚Äî Profesor</title>

  <!-- Tu CSS principal -->
 <link rel="stylesheet" href="/src/styles.css?v=20251210"/>

  <style>
  :root{
    --border:#d0d7e2;
    --muted:#6b7280;
    --shadow:0 18px 35px rgba(15,23,42,.12);
  }

  body{
    background:#f3f4f6;
    color:#111827;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }

  .wrap{
    max-width:1200px;
    margin:20px auto;
    padding:0 16px;
  }

  .row{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }

  h1{
    font-size:28px;
    margin:0;
  }

  table{
    width:100%;
    border-collapse:separate;
    border-spacing:0 6px;
  }

  th,
  td{
    padding:10px 12px;
    border:1px solid var(--border);
  }

  th{
    background:#e5ecf9;
    text-align:left;
  }

  td{
    background:#ffffff;
  }

  .pill{
    display:inline-flex;
    align-items:center;
    padding:4px 10px;
    border-radius:999px;
    background:#eef2ff;
    border:1px solid var(--border);
    color:#111827;
    font-size:.9rem;
  }

  .muted{
    color:var(--muted);
  }

  .topbar{
    background:#ffffff;
    border-bottom:1px solid var(--border);
    padding:12px 0;
  }

  .card{
    background:#ffffff;
    border:1px solid var(--border);
    border-radius:14px;
    padding:14px;
    margin:16px auto;
    color:#111827;
  }

  .auth-input{
    width:100%;
    height:48px;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid #d1d5db;
    background:#f9fafb;
    color:#111827;
  }

  .auth-input::placeholder{
    color:#9ca3af;
  }

  .primary{
    height:44px;
    border:0;
    border-radius:12px;
    background:#2563eb;
    color:#ffffff;
    font-weight:600;
    padding:0 14px;
    cursor:pointer;
  }

  .primary:disabled{
    opacity:.6;
    cursor:default;
  }

  .secondary{
    height:36px;
    border:1px solid #cbd5f5;
    border-radius:10px;
    background:#e5ecf9;
    color:#111827;
    padding:0 12px;
    cursor:pointer;
    font-weight:500;
  }

  /* Modal */
  .backdrop{
    position:fixed;
    inset:0;
    background:rgba(15,23,42,.25);
    display:none;
    z-index:300;
  }

  .modal{
    position:fixed;
    left:50%;
    top:6%;
    transform:translateX(-50%);
    width:min(980px,94vw);
    max-height:88vh;
    overflow:auto;
    background:#ffffff;
    border:1px solid var(--border);
    border-radius:14px;
    box-shadow:var(--shadow);
    display:none;
    z-index:301;
  }

  .modal header,
  .modal footer{
    padding:12px 16px;
    border-bottom:1px solid var(--border);
    background:#f9fafb;
  }

  .modal footer{
    border-top:1px solid var(--border);
    border-bottom:none;
    display:flex;
    justify-content:flex-end;
    gap:8px;
  }

  .modal .body{
    padding:14px;
    background:#ffffff;
  }

  /* Evidencias */
  .ev-grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
    gap:14px;
    margin-top:6px;
  }

  .ev-card{
    background:#ffffff;
    border:1px solid var(--border);
    border-radius:12px;
    overflow:hidden;
  }

  .ev-card img{
    width:100%;
    height:150px;
    object-fit:cover;
    background:#e5e7eb;
    display:block;
  }

  .ev-note{
    padding:8px 10px;
    color:#4b5563;
    font-size:.92rem;
    border-top:1px solid var(--border);
  }

  /* Toast */
  .toast{
    position:fixed;
    right:16px;
    bottom:16px;
    background:#ffffff;
    color:#111827;
    border:1px solid #cbd5f5;
    border-radius:12px;
    padding:12px 14px;
    box-shadow:0 10px 30px rgba(15,23,42,.18);
    display:none;
    z-index:400;
    font-size:.95rem;
  }

  .toast.ok{
    border-color:#16a34a;
  }

  .toast.err{
    border-color:#dc2626;
  }
</style>

</head>
<body>
  <header class="topbar">
    <div class="wrap row" style="justify-content:space-between">
      <h1>Panel del profesor</h1>
      <nav class="row">
        <button id="btn-logout" class="primary" type="button">Salir</button>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <div class="row" style="justify-content:space-between;margin-bottom:12px">
      <div class="row">
        <button id="btn-export-all" class="primary">Exportar CSV (todos)</button>
        <button id="btn-clear" class="primary">Borrar registros</button>
      </div>

      <span class="pill" id="count-pill">0 intentos</span>
    </div>

    <table id="tbl">
      <thead>
        <tr>
          <th>#</th>
          <th>Alumno</th>
          <th>C√≥digo</th>
          <th>Inicio</th>
          <th>Fin</th>
          <th>Duraci√≥n</th>
          <th>Off-tab (episodios)</th>
          <th>Mirada (episodios)</th>
          <th>Habla (episodios)</th>
          <th>Examen</th>
          <th>Ver</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </main>

  <!-- Banco de examen -->
  <section class="card" style="max-width:1200px">
    <h3>Banco de examen (CSV/JSON)</h3>
    <div class="row" style="flex-direction:column;gap:10px">
      <input id="exam-name" class="auth-input" placeholder="Nombre del examen" />
      <input id="exam-code-input" class="auth-input" placeholder="C√≥digo de examen" />
      <input id="exam-file" type="file" accept=".json,.csv" class="auth-input" />
      <button id="exam-upload" class="primary" style="align-self:flex-start">Cargar y activar</button>
    </div>
  </section>

  <!-- === Crear examen sin archivo === -->
  <section class="card" style="margin-top:16px; max-width:1200px;">
    <h3 style="margin:0 0 10px 0;">Crear examen (sin archivo)</h3>

    <div class="row" style="flex-direction:column;gap:10px">
      <input id="manual-exam-title" class="auth-input" placeholder="Nombre del examen" />
      <input id="manual-exam-code"  class="auth-input" placeholder="C√≥digo de examen (solo n√∫meros)"
             inputmode="numeric" autocomplete="off" />
    </div>

    <div id="manual-questions" style="margin-top:12px;"></div>

    <div class="row" style="gap:10px; margin-top:12px;">
      <button id="btn-add-q" class="secondary" type="button">Agregar pregunta</button>
      <button id="btn-save-exam" class="primary" type="button">Guardar y activar</button>
    </div>

  </section>

  <script>
    const $title = document.getElementById('manual-exam-title');
    const $code  = document.getElementById('manual-exam-code');
    const $qs    = document.getElementById('manual-questions');
    const $addQ  = document.getElementById('btn-add-q');
    const $save  = document.getElementById('btn-save-exam');

    // Solo d√≠gitos en el c√≥digo
    $code?.addEventListener('input', () => {
      $code.value = ($code.value || '').replace(/\D+/g, '');
    });

    // Validaciones similares a tu carga por archivo
    const EXAM_NAME_RE = /^[A-Za-z√Å√â√ç√ì√ö√ú√ë√°√©√≠√≥√∫√º√± ]{3,60}$/;
    const EXAM_CODE_RE = /^[0-9]{4,8}$/;

    // ‚úÖ Permitir texto ‚Äúnormal‚Äù: letras, n√∫meros, espacios, tildes y signos comunes
// (bloquea @ # $ etc.)
const HAS_ALNUM_RE = /[A-Za-z√Å√â√ç√ì√ö√ú√ë√°√©√≠√≥√∫√º√±]/;

// Enunciado (3 a 200 chars)
const Q_TEXT_RE = /^[A-Za-z0-9√Å√â√ç√ì√ö√ú√ë√°√©√≠√≥√∫√º√±¬ø?¬°!.,:;'"()\-_/+=*%<> ]{3,200}$/;

// Opciones (1 a 120 chars)
const OPT_TEXT_RE = /^[A-Za-z0-9√Å√â√ç√ì√ö√ú√ë√°√©√≠√≥√∫√º√±¬ø?¬°!.,:;'"()\-_/+=*%<> ]{1,120}$/;


    let questions = [];

    function addQuestion() {
      questions.push({
        text: '',
        options: ['', '', '', ''],
        correctIndex: 0
      });
      renderQuestions();
    }

    function removeQuestion(idx) {
      questions.splice(idx, 1);
      renderQuestions();
    }

    function escAttr(s){
      return String(s ?? '').replaceAll('"','&quot;');
    }

    function renderQuestions() {
      if (!$qs) return;
      $qs.innerHTML = '';

      questions.forEach((q, idx) => {
        const wrap = document.createElement('div');
        wrap.className = 'card';
        wrap.style.marginTop = '10px';
        wrap.style.padding = '12px';

        wrap.innerHTML = `
          <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
            <strong>Pregunta ${idx + 1}</strong>
            <button class="secondary" type="button" data-remove="${idx}">Quitar</button>
          </div>

          <input class="auth-input" style="margin-top:10px;"
                 placeholder="Enunciado de la pregunta"
                 value="${escAttr(q.text)}" data-qtext="${idx}" />

          <div style="margin-top:10px; display:grid; gap:8px;">
            ${q.options.map((opt, j) => `
              <input class="auth-input"
                     placeholder="Opci√≥n ${j + 1}"
                     value="${escAttr(opt)}"
                     data-opt="${idx}:${j}" />
            `).join('')}
          </div>

          <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <span style="opacity:.85;">Respuesta correcta:</span>
            <select class="auth-input" style="max-width:180px; height:44px;" data-correct="${idx}">
              ${q.options.map((_, j) => `
                <option value="${j}" ${Number(q.correctIndex) === j ? 'selected' : ''}>Opci√≥n ${j + 1}</option>
              `).join('')}
            </select>
          </div>
        `;

        $qs.appendChild(wrap);
      });

      // Binds (delegaci√≥n)
      $qs.querySelectorAll('[data-qtext]').forEach(inp => {
        inp.addEventListener('input', (e) => {
          const i = Number(e.target.dataset.qtext);
          questions[i].text = e.target.value;
        });
      });

      $qs.querySelectorAll('[data-opt]').forEach(inp => {
        inp.addEventListener('input', (e) => {
          const [i, j] = e.target.dataset.opt.split(':').map(Number);
          questions[i].options[j] = e.target.value;
        });
      });

      $qs.querySelectorAll('[data-correct]').forEach(sel => {
        sel.addEventListener('change', (e) => {
          const i = Number(e.target.dataset.correct);
          questions[i].correctIndex = Number(e.target.value);
        });
      });

      $qs.querySelectorAll('[data-remove]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          removeQuestion(Number(e.target.dataset.remove));
        });
      });
    }

    $addQ?.addEventListener('click', () => addQuestion());

    $save?.addEventListener('click', async () => {
      const title = ($title?.value || '').trim();
      const code  = ($code?.value || '').trim();

      if (!title) return alert('Escribe el nombre del examen.');
      if (!EXAM_NAME_RE.test(title)) return alert('Nombre inv√°lido (solo letras y espacios, 3‚Äì60).');

      if (!code) return alert('Escribe el c√≥digo del examen.');
      if (!EXAM_CODE_RE.test(code)) return alert('C√≥digo inv√°lido (solo n√∫meros, 4‚Äì8 d√≠gitos).');

      if (!questions.length) return alert('Agrega al menos 1 pregunta.');

      // Validaci√≥n r√°pida por pregunta (evita 400 por datos incompletos)
      for (let i = 0; i < questions.length; i++) {
  const q = questions[i];
  const text = (q.text || '').trim();
  const opts = (q.options || []).map(x => (x || '').trim());

  if (!text) return alert(`Falta el enunciado en la pregunta ${i + 1}.`);
  if (!Q_TEXT_RE.test(text) || !HAS_ALNUM_RE.test(text)) {
    return alert(`Pregunta ${i + 1}: enunciado inv√°lido. Usa solo letras/n√∫meros y signos comunes (no @@@@).`);
  }

  if (opts.some(o => !o)) return alert(`Completa TODAS las opciones en la pregunta ${i + 1}.`);

  // Validar cada opci√≥n
  for (let j = 0; j < opts.length; j++) {
    const o = opts[j];
    if (!OPT_TEXT_RE.test(o) || !HAS_ALNUM_RE.test(o)) {
      return alert(`Pregunta ${i + 1}: la opci√≥n ${j + 1} es inv√°lida. Evita caracteres como @ # $.`);
    }
  }

  // (Opcional) evitar opciones repetidas
  const norm = opts.map(o => o.toLowerCase());
  if (new Set(norm).size !== norm.length) {
    return alert(`Pregunta ${i + 1}: hay opciones repetidas. C√°mbialas para que sean diferentes.`);
  }

  if (Number(q.correctIndex) < 0 || Number(q.correctIndex) > opts.length - 1) {
    return alert(`Pregunta ${i + 1}: respuesta correcta inv√°lida.`);
  }
}

      // üëá IMPORTANTE:
      // Tu "upload por archivo" manda { name, accessCode, questions[{text, options, correct}] }
      // Entonces el manual debe mandar lo mismo + duplicado por compatibilidad.
      const normalizedQuestions = questions.map((q, i) => {
        const opts = (q.options || []).map(x => (x || '').trim());
        const correctIndex = Number(q.correctIndex);

        return {
          id: `q_${i + 1}`,
          text: (q.text || '').trim(),
          options: opts.map(String),
          correct: correctIndex,        // <- como tu carga por archivo (backend-friendly)
          correctIndex: correctIndex     // <- extra por compatibilidad
        };
      });

      const payload = {
        // Forma esperada (seg√∫n tu carga por archivo)
        name: title,
        accessCode: code,
        questions: normalizedQuestions,

        // Duplicado por compatibilidad (por si tu backend valida otros campos)
        title,
        code,
        exam: {
          name: title,
          title,
          accessCode: code,
          code,
          questions: normalizedQuestions
        }
      };

      $save.disabled = true;
      const old = $save.textContent;
      $save.textContent = 'Guardando...';

      try {
        const r = await fetch('/api/exams/set', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await r.json().catch(() => ({}));

        if (!r.ok || !data?.ok) throw new Error(data?.error || `Error ${r.status}`);

        alert('Examen guardado y activado ‚úÖ');

        // opcional: limpiar todo despu√©s de guardar
        // $title.value = '';
        // $code.value = '';
        // questions = [];
        // renderQuestions();

      } catch (e) {
        console.error(e);
        alert(e.message || 'No se pudo guardar el examen.');
      } finally {
        $save.disabled = false;
        $save.textContent = old;
      }
    });

    // Si quieres iniciar ya con 1 pregunta para que no se vea vac√≠o:
    if (questions.length === 0) addQuestion();
  </script>

  <!-- Modal detalle -->
  <div id="backdrop" class="backdrop" aria-hidden="true"></div>
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="m-title">
    <header>
      <div class="row" style="justify-content:space-between">
        <strong id="m-title">Detalle</strong>
        <button id="m-close" class="primary">Cerrar</button>
      </div>
    </header>
    <div class="body" id="m-body">‚Äî</div>
    <footer>
      <button id="m-export" class="primary">Exportar CSV (intento)</button>
    </footer>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <script type="module">
    import { requireRole, clearSession } from './src/roles.js';
    requireRole('prof');

    // Evitar que la vista se "reviva" con el bot√≥n Atr√°s
    window.addEventListener('pageshow', (event) => {
      const nav = performance.getEntriesByType('navigation')[0];
      const isBackForward = event.persisted || nav?.type === 'back_forward';

      if (isBackForward) {
        location.reload();
      }
    });

    const $ = (s)=>document.querySelector(s);

    // UI refs
    const tblBody   = $('#tbl tbody');
    const countPill = $('#count-pill');
    const btnAll    = $('#btn-export-all');
    const btnClr    = $('#btn-clear');

    const backdrop  = $('#backdrop');
    const modal     = $('#modal');
    const mTitle    = $('#m-title');
    const mBody     = $('#m-body');
    const mClose    = $('#m-close');
    const mExport   = $('#m-export');
    const toast     = $('#toast');

    // utils
    const fmtTime = (ms)=>{ const s=Math.floor((ms||0)/1000); const mm=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0'); return `${mm}:${ss}`; };
    const fmt = (ts)=>{ try{ return new Date(ts).toLocaleString(); }catch{ return '‚Äî'; } };
    const safe = (v)=> (v==null || v==='') ? '‚Äî' : String(v);

    function showToast(msg, ok=true){
      toast.textContent = msg;
      toast.classList.remove('ok','err');
      toast.classList.add(ok ? 'ok' : 'err');
      toast.style.display = 'block';
      setTimeout(()=>{ toast.style.display='none'; }, 2600);
    }

    // datos
    let DATA = [];
    let CURRENT_ATTEMPT = null;

    async function fetchAttemptsFromCloud() {
      const r = await fetch('/api/attempt/list?limit=200', { cache: 'no-store' });
      let j;
      try { j = await r.json(); }
      catch { throw new Error('Respuesta no JSON'); }
      if (!r.ok || !j.ok) throw new Error(j?.error || 'No se pudo cargar intentos');
      return j.items || [];
    }

    function render(items){
      DATA = items;
      countPill.textContent = `${items.length} intento${items.length===1?'':'s'}`;

      tblBody.innerHTML = items.map((a,i)=>{
        const off   = a.summary?.off_episodes ?? a.summary?.tab_activity?.off_episodes ?? 0;
        const look  = a.summary?.lookaway_episodes ?? a.summary?.attention?.lookaway_episodes ?? 0;
        const speak = a.summary?.speak_episodes ?? a.summary?.lips?.speak_episodes ?? 0;

        const ex  = a.exam || {};
        const examTxt = (ex.score != null && ex.total != null)
          ? `${ex.score}/${ex.total}`
          : (ex.correct != null && ex.total != null)
            ? `${ex.correct}/${ex.total}` : '‚Äî';

        return `
          <tr>
            <td>${i+1}</td>
            <td>${safe(a.student?.name)}</td>
            <td>${safe(a.student?.code)}</td>
            <td>${fmt(a.startedAt)}</td>
            <td>${fmt(a.endedAt)}</td>
            <td>${fmtTime(a.durationMs||0)}</td>
            <td>${off}</td>
            <td>${look}</td>
            <td>${speak}</td>
            <td>${examTxt}</td>
            <td><button class="primary" data-id="${a.id}">Ver</button></td>
          </tr>`;
      }).join('');
    }

    async function loadAndRender(){
      try{
        const items = await fetchAttemptsFromCloud();
        render(items);
      }catch(e){
        console.error(e);
        showToast(e.message || 'No se pudieron cargar los intentos', false);
        render([]);
      }
    }

    async function openDetail(id){
      let a = DATA.find(x => String(x.id) === String(id));
      if (!a) return;

      CURRENT_ATTEMPT = a;

      // 1) intenta usar lo que vino en la lista
      let evidences = Array.isArray(a.evidences) ? a.evidences
                    : Array.isArray(a.evidence)  ? a.evidence  : [];

      // 2) si no hay, pide el detalle al backend
      if (evidences.length === 0) {
        try {
          const r = await fetch(`/api/attempt/get?id=${encodeURIComponent(id)}`, { cache:'no-store' });
          const j = await r.json().catch(()=>null);
          if (j && j.ok && j.attempt) {
            a = { ...a, ...j.attempt };
            CURRENT_ATTEMPT = a;
            evidences = Array.isArray(a.evidences) ? a.evidences
                      : Array.isArray(a.evidence)  ? a.evidence  : [];
          }
        } catch (e) {
          console.warn('[detail] fetch detalle fall√≥:', e);
        }
      }

      const srcOf = (it) => {
        let s = it?.data || it?.image_base64 || it?.imageBase64 || it?.img || null;
        if (s && !String(s).startsWith('data:')) s = `data:image/jpeg;base64,${s}`;
        return s;
      };

      const off   = a.summary?.tab_activity?.off_episodes ?? a.summary?.off_episodes ?? 0;
      const look  = a.summary?.attention?.lookaway_episodes ?? a.summary?.lookaway_episodes ?? 0;
      const speak = a.summary?.lips?.speak_episodes ?? a.summary?.speak_episodes ?? 0;
      const ex = a.exam || {};
      const examTxt =
        (ex.score   != null && ex.total != null) ? `${ex.score}/${ex.total}` :
        (ex.correct != null && ex.total != null) ? `${ex.correct}/${ex.total}` : '‚Äî';

      mTitle.textContent = `Intento ${a.id} ‚Äî ${a.student?.name || ''}`;

      mBody.innerHTML = `
        <div class="row" style="margin-bottom:8px">
          <span class="pill">Inicio: ${fmt(a.startedAt)}</span>
          <span class="pill">Fin: ${fmt(a.endedAt)}</span>
          <span class="pill">Duraci√≥n: ${fmtTime(a.durationMs || 0)}</span>
          <span class="pill">Examen: ${examTxt}</span>
        </div>

        <h4>Resumen</h4>
        <ul>
          <li>Off-tab (episodios): ${off}</li>
          <li>Mirada desviada (episodios): ${look}</li>
          <li>Posible habla (episodios): ${speak}</li>
        </ul>

        <h4>Evidencias</h4>
        <div class="ev-grid" id="ev-grid">
          ${
            evidences.length
              ? evidences.map(it => {
                  const src = srcOf(it);
                  return `
                    <div class="ev-card">
                      ${src ? `<img src="${src}" alt="${it.kind||'evidencia'}" />`
                            : `<div class="muted" style="padding:10px;">Sin imagen adjunta</div>`}
                      <div class="ev-note">
                        ${fmt(it.t || it.taken_at || Date.now())} ‚Äî ${it.note || ''}
                      </div>
                    </div>`;
                }).join('')
              : '<div class="muted">No hay evidencias capturadas.</div>'
          }
        </div>
      `;

      backdrop.style.display = 'block';
      modal.style.display = 'block';
    }

    tblBody.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-id]');
      if (!btn) return;
      openDetail(btn.dataset.id);
    });

    mClose.addEventListener('click', ()=>{ backdrop.style.display='none'; modal.style.display='none'; });
    backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop){ backdrop.style.display='none'; modal.style.display='none'; }});

    function toCSV(rows, headers){
      const esc = v => `"${String(v??'').replaceAll('"','""')}"`;
      const head = headers.map(esc).join(',');
      const body = rows.map(r => headers.map(h => esc(r[h])).join(',')).join('\n');
      return head + '\n' + body;
    }

    btnAll.addEventListener('click', ()=>{
      if(!DATA.length){ showToast('No hay intentos', false); return; }
      const rows = DATA.map(a=>({
        id: a.id,
        nombre: a.student?.name ?? '',
        codigo: a.student?.code ?? '',
        inicio: fmt(a.startedAt),
        fin: fmt(a.endedAt),
        duracion: fmtTime(a.durationMs||0),
        off_tab_ep: a.summary?.tab_activity?.off_episodes ?? a.summary?.off_episodes ?? 0,
        mirada_ep:  a.summary?.attention?.lookaway_episodes ?? a.summary?.lookaway_episodes ?? 0,
        habla_ep:   a.summary?.lips?.speak_episodes ?? a.summary?.speak_episodes ?? 0,
        puntaje: (a.exam?.score ?? a.exam?.correct ?? ''),
        total:   (a.exam?.total ?? '')
      }));
      const csv = toCSV(rows, ['id','nombre','codigo','inicio','fin','duracion','off_tab_ep','mirada_ep','habla_ep','puntaje','total']);
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'intentos.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    mExport.addEventListener('click', ()=>{
      const row = CURRENT_ATTEMPT;
      if(!row){ showToast('Abre un intento primero', false); return; }
      const rows = [{
        id: row.id,
        nombre: row.student?.name ?? '',
        codigo: row.student?.code ?? '',
        inicio: fmt(row.startedAt),
        fin: fmt(row.endedAt),
        duracion: fmtTime(row.durationMs||0),
        off_tab_ep: row.summary?.tab_activity?.off_episodes ?? row.summary?.off_episodes ?? 0,
        mirada_ep:  row.summary?.attention?.lookaway_episodes ?? row.summary?.lookaway_episodes ?? 0,
        habla_ep:   row.summary?.lips?.speak_episodes ?? row.summary?.speak_episodes ?? 0,
        puntaje: (row.exam?.score ?? row.exam?.correct ?? ''),
        total:   (row.exam?.total ?? '')
      }];
      const csv = toCSV(rows, Object.keys(rows[0]));
      const blob = new Blob([csv], {type:'text/csv'});
      const an = document.createElement('a');
      an.href = URL.createObjectURL(blob);
      an.download = `intento_${row.id}.csv`;
      an.click();
      URL.revokeObjectURL(an.href);
    });

    // borrar registros
    btnClr.addEventListener('click', async () => {
      const ok = confirm('Esto eliminar√° TODOS los intentos registrados en el panel.\n¬øSeguro que deseas continuar?');
      if (!ok) return;

      try {
        const r = await fetch('/api/attempt/clear', { method: 'POST' });
        const j = await r.json().catch(() => null);

        if (!r.ok || !j?.ok) throw new Error(j?.error || 'No se pudieron borrar los intentos');

        try { localStorage.removeItem('proctor.attempts'); } catch {}

        showToast(`Se eliminaron ${j.deleted ?? 0} intentos.`, true);
        await loadAndRender();
      } catch (e) {
        console.error(e);
        showToast(e.message || 'Error al borrar los intentos', false);
      }
    });

    // subir examen (archivo)
    async function parseFileToQuestions(file) {
      const text = await file.text();
      if (file.name.toLowerCase().endsWith('.json')) {
        const j = JSON.parse(text);
        const list = Array.isArray(j) ? j : (j.questions || []);
        return list.map((q, i) => ({
          id: q.id ?? `q_${i+1}`,
          text: q.text ?? '',
          options: (q.options ?? []).map(String),
          correct: Number(q.correct ?? 0)
        }));
      } else if (file.name.toLowerCase().endsWith('.csv')) {
        const rows = text.trim().split(/\r?\n/).map(l => l.split(','));
        const hdr = rows.shift().map(h => h.trim().toLowerCase());
        const idx = (k) => hdr.indexOf(k);
        const out = [];
        for (const r of rows) {
          out.push({
            id: r[idx('id')] || '',
            text: r[idx('text')] || '',
            options: [r[idx('o1')], r[idx('o2')], r[idx('o3')], r[idx('o4')]].filter(Boolean),
            correct: Number(r[idx('correct')] || 0)
          });
        }
        return out;
      }
      throw new Error('Formato no soportado. Usa .json o .csv');
    }

    $('#exam-upload').addEventListener('click', async ()=> {
      const rawName = ($('#exam-name')?.value || '').trim();
      const rawCode = ($('#exam-code-input')?.value || '').trim();
      const file    = $('#exam-file')?.files?.[0];

      if (!rawName) return showToast('Ingresa un nombre para el examen', false);
      if (!EXAM_NAME_RE.test(rawName)) return showToast('Nombre de examen inv√°lido (solo letras y espacios, 3‚Äì60 caracteres).', false);

      if (!rawCode) return showToast('Ingresa un c√≥digo de examen (4‚Äì8 d√≠gitos).', false);
      if (!EXAM_CODE_RE.test(rawCode)) return showToast('C√≥digo de examen inv√°lido (solo n√∫meros, 4‚Äì8 d√≠gitos).', false);

      if (!file) return showToast('Selecciona un archivo CSV/JSON', false);

      try {
        const questions = await parseFileToQuestions(file);

        const r = await fetch('/api/exams/set', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ name: rawName, accessCode: rawCode, questions })
        });

        let j; try { j = await r.json(); } catch { throw new Error('Respuesta no JSON'); }
        if (!r.ok || !j.ok) throw new Error(j.error || 'Error guardando el examen');

        showToast(`Examen "${rawName}" activado (${j.saved} preguntas). C√≥digo: ${rawCode}`, true);
      } catch(e) {
        console.error(e);
        showToast(e.message || 'Error guardando el examen', false);
      }
    });

    // logout
    const btnLogout = document.getElementById('btn-logout');
    btnLogout?.addEventListener('click', async (e) => {
      e.preventDefault();
      try { await fetch('/api/auth/logout', { method: 'POST' }); } catch {}
      clearSession();
      location.href = 'login.html';
    });

    loadAndRender();
  </script>
</body>
</html>
