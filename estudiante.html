<script type="module">
  import { requireRole } from './src/roles.js';
  requireRole(['student']); // evita ver la página si no está logueado como student
  // Fuerza recarga cuando se vuelve con Atrás/Adelante
window.addEventListener('pageshow', (event) => {
  // event.persisted = true → la página vino del bfcache
  const nav = performance.getEntriesByType('navigation')[0];
  const isBackForward = event.persisted || nav?.type === 'back_forward';

  if (isBackForward) {
    // recarga desde el servidor → se vuelve a ejecutar requireRole(...)
    location.reload();
  }
});

</script>

<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Evaluación — Estudiante</title>
  <link rel="stylesheet" href="/src/styles.css?v=20251120">

<!-- En encargado.html, dentro de <head>, debajo del link a styles.css -->
<style>
  /* Fuerza tema oscuro en esta página */
  body { 
    background:
      radial-gradient(1200px 600px at 20% -10%, rgba(42,84,190,.22), transparent 60%),
      radial-gradient(900px 500px at 110% 10%, rgba(1,35,80,.22), transparent 55%),
      #0a1020;
    color:#e6edf7;
  }
  .card, table th, table td { background:#0b1324; border-color:#13233f; }
</style>


  <style>
    .grid-2{display:grid;grid-template-columns:1.2fr .8fr;gap:18px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input{padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="wrap">
      <h1>Evaluación (Estudiante)</h1>
      <nav>
        <a id="open-privacy" href="/privacidad.html" target="_blank" rel="noopener">Privacidad</a>
        <a id="btn-logout" href="login.html">Salir</a>
      </nav>
    </div>
  </header>

  <main class="wrap grid-2">
    <section>
      <!-- Datos del estudiante -->
      <div class="card">
        <h2>Datos del estudiante</h2>
        <div class="row">
          <input id="student-name"  placeholder="Nombre y apellidos" style="flex:1" />
          <input id="student-code"  placeholder="Código"           style="width:180px" />
          <input id="student-email" placeholder="Correo (opcional)" style="width:260px" />
        </div>
        <p class="help">Se guardarán junto con el resumen del monitoreo.</p>
      </div>

        <div class="exam-row">
    <label for="exam-code">Código de examen</label>
    <input id="exam-code" class="auth-input" placeholder="Código que indica el profesor" />
  </div>

      <!-- Examen -->
      <div class="card">
        <h2>Examen</h2>
        <div class="quiz">
          <div class="quiz-meta">
            Pregunta <span id="exam-idx">0</span>/<span id="exam-total">0</span> · RT: <span id="exam-rt">0.0</span>s
          </div>
          <div id="q-text" class="q-text">Por favor, ingrese sus datos correctamente y prenda su cámara con el objetivo de iniciar el monitoreo correspondiente. De lo contrario, no podrá empezar el examen. Recuerde que debe presionar el botón 'Iniciar monitoreo' justo antes de empezar el examen y 'Finalizar monitoreo' al terminarlo. </div>
          <div id="q-options" class="q-options"></div>
          <div class="exam-actions">
            <button id="btn-exam-start"  class="primary">Iniciar test</button>
            <button id="btn-exam-next"   class="secondary hidden">Siguiente</button>
            <button id="btn-exam-finish" class="secondary hidden">Finalizar</button>
          </div>
          <div id="exam-result" class="hidden"></div>
        </div>
      </div>

      <!-- Cámara -->
      <div class="card">
        <h2>Cámara</h2>
        <p>Estado: <span id="cam-status" class="pill pill-neutral">Permiso pendiente</span></p>
        <div id="cam-help" class="help hidden"></div>

        <div class="row" style="margin-bottom:10px">
          <button id="btn-permitir"   class="primary">Permitir cámara</button>
          <button id="btn-reintentar" class="secondary">Reintentar</button>
        </div>

        <div class="video-wrap">
          <video id="cam" autoplay playsinline muted></video>
          <canvas id="canvas"></canvas>
        </div>

        <div class="row" style="margin-top:10px">
          <button id="btn-start" class="primary">Iniciar monitoreo</button>
          <button id="btn-stop" class="secondary">Finalizar monitoreo</button>

      
        </div>

        <div class="row" style="margin-top:6px">
          <span>Sesión: <strong id="session-status">Detenida</strong></span>
          <span>· Tiempo: <strong id="session-time">00:00</strong></span>
        </div>
      </div>
    </section>

    
  </main>

  <!-- Modal Resumen -->
  <div id="summary-backdrop" class="modal-backdrop hidden" aria-hidden="true"></div>
  <div id="summary-modal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div style="display:flex;align-items:center;gap:10px;">
        <h3 style="margin:0;">Resumen de la sesión</h3>
        <span style="flex:1"></span>
        <button id="summary-download-json" class="secondary">Descargar JSON</button>
        <button id="summary-download-csv"  class="secondary">Descargar CSV</button>
        <button id="summary-close"         class="secondary">Cerrar</button>
      </div>
      <div id="summary-body" style="margin-top:12px;"></div>
    </div>
  </div>

  <!-- Modal Evidencias -->
  <div id="evidence-backdrop" class="modal-backdrop hidden" aria-hidden="true"></div>
  <div id="evidence-modal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div style="display:flex;align-items:center;gap:10px;">
        <h3 style="margin:0;">Evidencias capturadas</h3>
        <span style="flex:1"></span>
        <button id="btn-evid-download" class="secondary">Descargar JSON</button>
        <button id="btn-evid-close"    class="secondary">Cerrar</button>
      </div>
      <div id="evidence-grid" style="margin-top:12px;"></div>
    </div>
  </div>

  <!-- Gate de rol -->
<script type="module">
import { requireRole, clearSession } from './src/roles.js';
requireRole('student');

window.addEventListener('pageshow', (event) => {
  const nav = performance.getEntriesByType('navigation')[0];
  const isBackForward = event.persisted || nav?.type === 'back_forward';

  if (isBackForward) {
    location.reload();
  }
});
</script>

<!-- Orden: helpers -> examen -> app -->
<script type="module" src="./src/bootstrap-student.js"></script>



</body>
</html>
