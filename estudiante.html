<script type="module">
async function requireAuth(needRole) {
  // importante: credentials:'include' para enviar la cookie HttpOnly
  const r = await fetch('/api/auth/me', { credentials: 'include' });
  if (!r.ok) { location.replace('login.html'); return null; }
  const { user } = await r.json();
  if (needRole && user.role !== needRole) { location.replace('login.html'); return null; }
  return user;
}

const me = await requireAuth('student'); // o null si redirige
if (!me) { /* salió del flujo */ }
// Si quieres, rellena los campos del alumno:
document.querySelector('#student-name')?.setAttribute('value', me.name ?? '');
document.querySelector('#student-code')?.setAttribute('value', me.code ?? '');
window.__me = me; // por si lo usa tu app más adelante
</script>



<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Evaluación — Estudiante</title>
  <link rel="stylesheet" href="./src/styles.css" />
  <style>
    .grid-2{display:grid;grid-template-columns:1.2fr .8fr;gap:18px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input{padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="wrap">
      <h1>Evaluación (Estudiante)</h1>
      <nav>
        <a id="open-privacy" href="/privacidad.html" target="_blank" rel="noopener">Privacidad</a>
        <a id="btn-logout" href="login.html">Salir</a>
      </nav>
    </div>
  </header>

  <main class="wrap grid-2">
    <section>
      <!-- Datos del estudiante -->
      <div class="card">
        <h2>Datos del estudiante</h2>
        <div class="row">
          <input id="student-name"  placeholder="Nombre y apellidos" style="flex:1" />
          <input id="student-code"  placeholder="Código"           style="width:180px" />
          <input id="student-email" placeholder="Correo (opcional)" style="width:260px" />
        </div>
        <p class="help">Se guardarán junto con el resumen del monitoreo.</p>
      </div>

      <!-- Examen -->
      <div class="card">
        <h2>Examen</h2>
        <div class="quiz">
          <div class="quiz-meta">
            Pregunta <span id="exam-idx">0</span>/<span id="exam-total">0</span> · RT: <span id="exam-rt">0.0</span>s
          </div>
          <div id="q-text" class="q-text">—</div>
          <div id="q-options" class="q-options"></div>
          <div class="exam-actions">
            <button id="btn-exam-start"  class="primary">Iniciar test</button>
            <button id="btn-exam-next"   class="secondary hidden">Siguiente</button>
            <button id="btn-exam-finish" class="secondary hidden">Finalizar</button>
          </div>
          <div id="exam-result" class="hidden"></div>
        </div>
      </div>

      <!-- Cámara -->
      <div class="card">
        <h2>Cámara</h2>
        <p>Estado: <span id="cam-status" class="pill pill-neutral">Permiso pendiente</span></p>
        <div id="cam-help" class="help hidden"></div>

        <div class="row" style="margin-bottom:10px">
          <button id="btn-permitir"   class="primary">Permitir cámara</button>
          <button id="btn-reintentar" class="secondary">Reintentar</button>
        </div>

        <div class="video-wrap">
          <video id="cam" autoplay playsinline muted></video>
          <canvas id="canvas"></canvas>
        </div>

        <div class="row" style="margin-top:10px">
          <button id="btn-start" class="primary">Iniciar monitoreo</button>
          <button id="btn-stop" class="secondary">Finalizar monitoreo</button>

      
        </div>

        <div class="row" style="margin-top:6px">
          <span>Sesión: <strong id="session-status">Detenida</strong></span>
          <span>· Tiempo: <strong id="session-time">00:00</strong></span>
        </div>
      </div>
    </section>

    
  </main>

  <!-- Modal Resumen -->
  <div id="summary-backdrop" class="modal-backdrop hidden" aria-hidden="true"></div>
  <div id="summary-modal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div style="display:flex;align-items:center;gap:10px;">
        <h3 style="margin:0;">Resumen de la sesión</h3>
        <span style="flex:1"></span>
        <button id="summary-download-json" class="secondary">Descargar JSON</button>
        <button id="summary-download-csv"  class="secondary">Descargar CSV</button>
        <button id="summary-close"         class="secondary">Cerrar</button>
      </div>
      <div id="summary-body" style="margin-top:12px;"></div>
    </div>
  </div>

  <!-- Modal Evidencias -->
  <div id="evidence-backdrop" class="modal-backdrop hidden" aria-hidden="true"></div>
  <div id="evidence-modal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-card">
      <div style="display:flex;align-items:center;gap:10px;">
        <h3 style="margin:0;">Evidencias capturadas</h3>
        <span style="flex:1"></span>
        <button id="btn-evid-download" class="secondary">Descargar JSON</button>
        <button id="btn-evid-close"    class="secondary">Cerrar</button>
      </div>
      <div id="evidence-grid" style="margin-top:12px;"></div>
    </div>
  </div>

  <!-- Gate de rol -->
<script type="module">
  import { requireRole } from './src/src/roles.js';
  requireRole('student');
</script>

<!-- Orden: helpers -> examen -> app -->
<script type="module" src="./src/bootstrap-student.js"></script>



</body>
</html>
