<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ingreso</title>

  <!-- Tu hoja global -->
  <link rel="stylesheet" href="./src/styles.css"/>

  <style>
    /* ===== Fondo general (oscuro con sutil gradiente) ===== */
    body.auth {
      min-height: 100vh;
      margin: 0;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(42,84,190,.22), transparent 60%),
        radial-gradient(900px 500px at 110% 10%, rgba(1,35,80,.22), transparent 55%),
        #0a1020;
      color: #e6edf7;
      display: grid;
      place-items: center;
      padding: 28px 16px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Source Sans Pro", sans-serif;
    }
    .wrap { width: 100%; max-width: 560px; }

    /* ===== Card ===== */
    .auth-card {
      background:#0b1324;
      border:1px solid #13233f;
      border-radius:18px;
      padding:28px;
      box-shadow:
        0 8px 28px rgba(2,8,23,.45),
        inset 0 1px rgba(255,255,255,.04);
    }
    .auth-card h2{ margin:0 0 18px; font-size:28px; color:#e6edf7; letter-spacing:.2px; }

    /* ===== Form ===== */
    .row{ display:flex; flex-direction:column; gap:12px }
    .row.right{ align-items:flex-end; gap:10px }

    .auth-input{
      width:100%; height:56px; padding:14px 16px; border-radius:14px;
      border:1px solid #1c2a48; background:#0e1a2f; color:#e6edf7; outline:none;
      transition: box-shadow .15s ease, border-color .15s ease, background .15s ease;
    }
    .auth-input::placeholder{ color:#b9c6dc; opacity:.9; }
    .auth-input:focus{ border-color:#335bd8; box-shadow:0 0 0 3px rgba(51,91,216,.25); background:#0f1e37; }

    .primary{
      height:56px; border:0; border-radius:14px; background:#2f6cf6; color:#fff;
      font-weight:600; font-size:18px; cursor:pointer;
      transition: transform .06s ease, box-shadow .15s ease, background .15s ease;
      box-shadow:0 10px 24px rgba(47,108,246,.34);
    }
    .primary:hover{ background:#2a5fe0; }
    .primary:active{ transform:translateY(1px); box-shadow:0 6px 16px rgba(47,108,246,.34); }
    .secondary{
      height:48px; border:1px solid #29406d; border-radius:12px; background:#0e1a2f; color:#e6edf7;
      padding:0 16px; cursor:pointer;
    }

    /* ===== Modales ===== */
    .hidden{ display:none }
    .modal{
      position:fixed; inset:0; display:grid; place-items:center;
      background:rgba(3,10,24,.62); backdrop-filter: blur(3px); z-index:50;
    }
    .modal-card{
      width:min(640px, 92vw);
      background:#0b1324; border:1px solid #13233f; border-radius:18px; padding:22px;
      box-shadow:0 18px 48px rgba(0,0,0,.5);
    }
    .modal-card h3{ margin:0 0 12px; }
    .check-badge{
      margin:6px auto 12px; width:56px; height:56px; border-radius:9999px;
      background:#0ea5a5; display:grid; place-items:center;
    }
    .muted{ opacity:.9 }
  </style>
</head>
<body class="auth">
  <main class="wrap">
    <div class="auth-card">
      <h2>Ingreso</h2>
      <div class="row">
        <input id="user" class="auth-input" placeholder="Usuario (correo)" autocomplete="username" />
        <input id="pass" class="auth-input" type="password" placeholder="Contraseña" autocomplete="current-password" minlength="8"
  maxlength="32" />
        <button id="btn" class="primary" type="button">Entrar</button>
        <button id="btn-register" class="secondary" type="button">Crear cuenta</button>
      </div>
    </div>
  </main>

  <!-- Modal de registro -->
  <div id="reg-modal" class="modal hidden">
    <div class="modal-card">
      <h3>Crear cuenta</h3>
      <div class="row">
        <!-- Nombre -->
        <input
          id="reg-name"
          class="auth-input"
          placeholder="Nombre"
          autocomplete="name"
          minlength="2"
          maxlength="60"
          pattern="^[A-Za-zÁÉÍÓÚÜÑáéíóúüñ]+(?:[ '\-][A-Za-zÁÉÍÓÚÜÑáéíóúüñ]+)*$"
          required
        />

        <!-- Correo -->
        <input
          id="reg-email"
          class="auth-input"
          type="email"
          inputmode="email"
          placeholder="Correo"
          autocomplete="username"
          pattern="^(?!.*\.\.)(?!.*\.$)(?!^\.)[A-Za-z0-9](?:[A-Za-z0-9._%+-]{0,62}[A-Za-z0-9])?@[A-Za-z0-9](?:[A-Za-z0-9-]{0,61}[A-Za-z0-9])?(?:\.[A-Za-z0-9](?:[A-Za-z0-9-]{0,61}[A-Za-z0-9])?)+$"
          title="Correo inválido: sin puntos consecutivos ni punto al inicio/fin y dominio válido."
        />

        <!-- Código de estudiante (solo números) -->
        <input
          id="reg-code"
          class="auth-input"
          placeholder="Código de estudiante"
          inputmode="numeric"
          autocomplete="off"
          maxlength="12"
        />

        <!-- Contraseña -->
        <input
          id="reg-pass"
          class="auth-input"
          type="password"
          placeholder="Contraseña"
          autocomplete="new-password"
          minlength="8"
  maxlength="32"
        />

        <!-- Rol (por ahora solo estudiante) -->
        <select id="reg-role" class="auth-input">
          <option value="student">Estudiante</option>
        </select>

        <div class="row right">
          <button id="reg-cancel" class="secondary" type="button">Cancelar</button>
          <button id="reg-submit" class="primary" type="button">Crear</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de confirmación (lo seguimos usando si quieres más adelante) -->
  <div id="info-modal" class="modal hidden">
    <div class="modal-card" style="text-align:center">
      <div class="check-badge">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M20 6L9 17l-5-5" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
      <h3 id="info-title">Cuenta creada</h3>
      <p id="info-body" class="muted">Ya puedes iniciar sesión con tu correo y contraseña.</p>
      <div class="row right">
        <button id="info-ok" class="primary" type="button">Entendido</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { setSession } from './src/roles.js';

    const $  = (id)=>document.getElementById(id);
    const show = el => el.classList.remove('hidden');
    const hide = el => el.classList.add('hidden');
    
    
    const EMAIL_RE =
    /^(?!.*\.\.)(?!.*\.$)(?!^\.)[A-Za-z0-9](?:[A-Za-z0-9._%+-]{0,62}[A-Za-z0-9])?@[A-Za-z0-9](?:[A-Za-z0-9-]{0,61}[A-Za-z0-9])?(?:\.[A-Za-z0-9](?:[A-Za-z0-9-]{0,61}[A-Za-z0-9])?)*\.[A-Za-z]{2,4}$/;


    const NAME_RE =
      /^(?=.{2,60}$)[A-Za-zÁÉÍÓÚÜÑáéíóúüñ]+(?:[ '\-][A-Za-zÁÉÍÓÚÜÑáéíóúüñ]+)*$/;

    // Código: solo dígitos, por ejemplo de 4 a 12
    const CODE_RE = /^\d{4,12}$/;

    // Normaliza: colapsa espacios y recorta
    const clean = (s='') => s.normalize('NFKC').replace(/\s+/g, ' ').trim();

    // ==== LOGIN ====
    $('btn').addEventListener('click', async () => {
      const email = $('user').value.trim();
      const password = $('pass').value.trim();
      if (!email || !password) return alert('Completa usuario y contraseña');

      let r, j;
      try {
        r = await fetch('/api/auth/login', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ email, password })
        });
        j = await r.json();
      } catch {
        alert('Error de red');
        return;
      }
      if (!r.ok || !j.ok) return alert(j?.error || 'Login fallido');

            setSession(j.user); // { id, name, email, role }

      if (j.user.role === 'prof') {
        location.replace('encargado.html');
      } else if (j.user.role === 'admin') {
        location.replace('admin.html');
      } else {
        location.replace('estudiante.html');
      }
    });

    // Enter para enviar
    ['user','pass'].forEach(id=>{
      $(id).addEventListener('keydown', e => {
        if (e.key === 'Enter') $('btn').click();
      });
    });

    // ==== REGISTRO ====

    // Deja el formulario limpio
    function resetRegForm() {
      $('reg-name').value  = '';
      $('reg-email').value = '';
      $('reg-code').value  = '';
      $('reg-pass').value  = '';
      $('reg-role').value  = 'student';
    }

    // Abrir modal: siempre limpio
    $('btn-register').addEventListener('click', () => {
      resetRegForm();
      show($('reg-modal'));
    });

    // Cancelar: cierra y limpia
    $('reg-cancel').addEventListener('click', () => {
      hide($('reg-modal'));
      resetRegForm();
    });

    $('reg-submit').addEventListener('click', async () => {
      const name  = clean($('reg-name').value);
      const email = $('reg-email').value.trim().toLowerCase();
      const code  = $('reg-code').value.trim();
      const password = $('reg-pass').value.trim();
      const role  = 'student'; // fijo por ahora

      if (!name || !email || !code || !password)
        return alert('Completa todos los campos');

      if (!NAME_RE.test(name))
        return alert('Ingresa el nombre correctamente.');

      if (!EMAIL_RE.test(email))
        return alert('Correo inválido.');

      if (!CODE_RE.test(code))
        return alert('El código de estudiante debe tener solo números (4 a 12 dígitos).');

      if (password.length < 6)
        return alert('La contraseña debe tener al menos 6 caracteres.');

      let r, j;
      try {
        r = await fetch('/api/auth/register', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ name, email, password, role, code })
        });
        j = await r.json().catch(() => ({}));
      } catch (e) {
        alert('Error de red al registrar.');
        return;
      }

      if (!r.ok || !j.ok)
        return alert(j?.error || 'No se pudo registrar');

      alert('Cuenta creada correctamente. Ahora inicia sesión.');
      hide($('reg-modal'));
      resetRegForm();
    });

    // Cerrar modal de info si lo usas más adelante
    $('info-ok')?.addEventListener('click', () => {
      hide($('info-modal'));
    });
  </script>
</body>
</html>
