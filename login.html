<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ingreso</title>
  <link rel="stylesheet" href="./src/styles.css"/>
  <style>
    /* ===== Fondo general (oscuro con sutil gradiente) ===== */
    body.auth {
      min-height: 100vh;
      margin: 0;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(42,84,190,.22), transparent 60%),
        radial-gradient(900px 500px at 110% 10%, rgba(1,35,80,.22), transparent 55%),
        #0a1020;
      color: #e6edf7;
      display: grid;
      place-items: center;
      padding: 28px 16px;
    }

    /* ===== Contenedor ===== */
    .wrap { width: 100%; max-width: 560px; }

    /* ===== Card de login ===== */
    .auth-card {
      background:#0b1324;
      border:1px solid #13233f;
      border-radius:18px;
      padding:28px;
      box-shadow:
        0 8px 28px rgba(2,8,23,.45),
        inset 0 1px rgba(255,255,255,.04);
    }

    .auth-card h2{
      margin: 0 0 18px 0;
      font-size: 28px;
      line-height: 1.2;
      color:#e6edf7;
      letter-spacing:.2px;
    }

    /* ===== Form ===== */
    .row{display:flex;flex-direction:column;gap:12px}

    .auth-input{
      width:100%;
      height:56px;
      padding:14px 16px;
      border-radius:14px;
      border:1px solid #1c2a48;
      background:#0e1a2f;
      color:#e6edf7;
      outline:none;
      transition: box-shadow .15s ease, border-color .15s ease, background .15s ease;
    }
    .auth-input::placeholder{ color:#b9c6dc; opacity:.9; }

    .auth-input:focus{
      border-color:#335bd8;
      box-shadow:0 0 0 3px rgba(51,91,216,.25);
      background:#0f1e37;
    }

    /* Botón primario (por si tu styles.css no define .primary) */
    .primary{
      height:56px;
      border:0;
      border-radius:14px;
      background:#2f6cf6;
      color:#fff;
      font-weight:600;
      font-size:18px;
      cursor:pointer;
      transition: transform .06s ease, box-shadow .15s ease, background .15s ease;
      box-shadow:0 10px 24px rgba(47,108,246,.34);
    }
    .primary:hover{ background:#2a5fe0; }
    .primary:active{ transform:translateY(1px); box-shadow:0 6px 16px rgba(47,108,246,.34); }
  </style>
</head>
<body class="auth">
  <main class="wrap">
    <div class="auth-card">
      <h2>Ingreso</h2>

      <div class="row">
        <input id="user" class="auth-input" placeholder="Usuario" autocomplete="username" />
        <input id="pass" class="auth-input" type="password" placeholder="Contraseña" autocomplete="current-password" />
        <button id="btn" class="primary">Entrar</button>
        <button id="btn-register" class="secondary">Crear cuenta</button>
      </div>
    </div>
  </main>

  <!-- ===== Modal de registro en la misma interfaz ===== -->
  <dialog id="register-dialog" class="modal">
    <form id="form-register" class="modal-card" method="dialog" novalidate>
      <h3 style="margin:0 0 10px 0">Crear cuenta</h3>

      <label>Nombre
        <input id="reg-name" type="text" required />
      </label>

      <label>Correo
        <input id="reg-email" type="email" autocomplete="email" required />
      </label>

      <label>Contraseña
        <input id="reg-pass" type="password" autocomplete="new-password" minlength="6" required />
      </label>

      <label>Rol
        <select id="reg-role">
          <option value="student">Estudiante</option>
          <option value="prof">Profesor</option>
        </select>
      </label>

      <div class="row end" style="margin-top:12px">
        <button type="button" id="reg-cancel" class="secondary">Cancelar</button>
        <button type="submit" id="reg-submit" class="primary">Crear</button>
      </div>

      <p id="reg-msg" class="msg"></p>
    </form>
  </dialog>

  <!-- ===== Lógica de Login + Registro (API real) ===== -->
  <script type="module">
    // Helpers sin colisión
    const qs  = (s) => document.querySelector(s);
    const qsi = (s) => /** @type {HTMLInputElement} */(document.querySelector(s));

    async function doLogin() {
      const email = qsi('#user').value.trim();
      const password = qsi('#pass').value.trim();
      if (!email || !password) {
        alert('Completa usuario y contraseña');
        return;
      }

      const r = await fetch('/api/auth/login', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ email, password })
      });
      const j = await r.json();
      if (!j.ok) return alert(j.error || 'No se pudo iniciar sesión');

      // Redirección según rol
      if (j.user.role === 'prof') location.replace('encargado.html');
      else location.replace('estudiante.html');
    }

    // Click en Entrar
    qs('#btn')?.addEventListener('click', doLogin);
    // Enter para enviar
    ['#user','#pass'].forEach(sel => {
      qsi(sel)?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') doLogin();
      });
    });

    // Abrir/cerrar modal de registro
    const dlg = /** @type {HTMLDialogElement} */ (qs('#register-dialog'));
    qs('#btn-register')?.addEventListener('click', () => dlg.showModal());
    qs('#reg-cancel')?.addEventListener('click', () => dlg.close());

    // Registro
    qs('#form-register')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const name     = qsi('#reg-name').value.trim();
      const email    = qsi('#reg-email').value.trim();
      const password = qsi('#reg-pass').value.trim();
      const role     = qsi('#reg-role').value;
      const msg      = qs('#reg-msg');

      msg.textContent = '';

      if (!name || !email || !password) {
        msg.textContent = 'Completa todos los campos.';
        return;
      }

      const r = await fetch('/api/auth/register', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ name, email, password, role })
      });
      const j = await r.json();

      if (!j.ok) {
        msg.textContent = j.error || 'No se pudo registrar';
        return;
      }

      msg.textContent = 'Cuenta creada. Redirigiendo…';
      if (j.user.role === 'prof') location.replace('encargado.html');
      else location.replace('estudiante.html');
    });
  </script>

  <!-- ❗️IMPORTANTE: Elimina el bloque antiguo con setRole/CREDS (MVP).
       Si lo dejas activo, se "pelea" con el login real y duplica listeners. -->
</body>
</html>
