<!-- Modal de registro (oculto por defecto) -->
<div id="reg-modal" class="modal hidden">
  <div class="modal-card">
    <h3>Crear cuenta</h3>

    <input id="reg-name"  class="auth-input" placeholder="Nombre" />
    <input id="reg-email" class="auth-input" placeholder="Correo" autocomplete="username" />
    <input id="reg-pass"  class="auth-input" type="password" placeholder="ContraseÃ±a" autocomplete="new-password" />
    <select id="reg-role" class="auth-input">
      <option value="student">Estudiante</option>
      <option value="prof">Profesor</option>
    </select>

    <div class="row right">
      <button id="reg-cancel" class="secondary">Cancelar</button>
      <button id="reg-submit" class="primary">Crear</button>
    </div>
  </div>
</div>

<script type="module">
  import { setSession } from './src/roles.js';

  const $  = (id)=>document.getElementById(id);
  const show = el => el.classList.remove('hidden');
  const hide = el => el.classList.add('hidden');

  // LOGIN
  $('btn').addEventListener('click', async () => {
    const email = $('user').value.trim();
    const password = $('pass').value.trim();
    let r, j;
    try {
      r = await fetch('/api/auth/login', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ email, password })
      });
      j = await r.json();
    } catch {
      alert('Error de red'); return;
    }
    if (!r.ok || !j.ok) return alert(j?.error || 'Login fallido');

    setSession(j.user);                          // <-- guardamos {id,name,email,role}
    location.replace(j.user.role === 'prof' ? 'encargado.html' : 'estudiante.html');
  });

  // Enter
  ['user','pass'].forEach(id=>{
    $(id).addEventListener('keydown', e => { if (e.key === 'Enter') $('btn').click(); });
  });

  // ABRIR / CERRAR MODAL REGISTRO
  $('btn-register').addEventListener('click', () => show($('reg-modal')));
  $('reg-cancel').addEventListener('click', () => hide($('reg-modal')));

  // SUBMIT REGISTRO
  $('reg-submit').addEventListener('click', async () => {
    const name  = $('reg-name').value.trim();
    const email = $('reg-email').value.trim();
    const password = $('reg-pass').value.trim();
    const role  = $('reg-role').value;

    if (!name || !email || !password) return alert('Completa todos los campos');

    let r, j;
    try {
      r = await fetch('/api/auth/register', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ name, email, password, role })
      });
      j = await r.json();
    } catch {
      alert('Error de red'); return;
    }
    if (!r.ok || !j.ok) return alert(j?.error || 'No se pudo registrar');

    setSession(j.user);
    location.replace(j.user.role === 'prof' ? 'encargado.html' : 'estudiante.html');
  });
</script>
