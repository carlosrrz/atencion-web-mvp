<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Ingreso</title>
  <link rel="stylesheet" href="./src/styles.css"/>
  <style>
    /* ===== Fondo general (oscuro con sutil gradiente) ===== */
    body.auth {
      min-height: 100vh;
      margin: 0;
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(42,84,190,.22), transparent 60%),
        radial-gradient(900px 500px at 110% 10%, rgba(1,35,80,.22), transparent 55%),
        #0a1020;
      color: #e6edf7;
      display: grid;
      place-items: center;
      padding: 28px 16px;
    }

    /* ===== Contenedor ===== */
    .wrap { width: 100%; max-width: 560px; }

    /* ===== Card de login ===== */
    .auth-card {
      background:#0b1324;
      border:1px solid #13233f;
      border-radius:18px;
      padding:28px;
      box-shadow:
        0 8px 28px rgba(2,8,23,.45),
        inset 0 1px rgba(255,255,255,.04);
    }

    .auth-card h2{
      margin: 0 0 18px 0;
      font-size: 28px;
      line-height: 1.2;
      color:#e6edf7;
      letter-spacing:.2px;
    }

    /* ===== Form ===== */
    .row{display:flex;flex-direction:column;gap:12px}

    .auth-input{
      width:100%;
      height:56px;
      padding:14px 16px;
      border-radius:14px;
      border:1px solid #1c2a48;
      background:#0e1a2f;
      color:#e6edf7;
      outline:none;
      transition: box-shadow .15s ease, border-color .15s ease, background .15s ease;
    }
    .auth-input::placeholder{ color:#b9c6dc; opacity:.9; }

    .auth-input:focus{
      border-color:#335bd8;
      box-shadow:0 0 0 3px rgba(51,91,216,.25);
      background:#0f1e37;
    }

    /* Botón primario (por si tu styles.css no define .primary) */
    .primary{
      height:56px;
      border:0;
      border-radius:14px;
      background:#2f6cf6;
      color:#fff;
      font-weight:600;
      font-size:18px;
      cursor:pointer;
      transition: transform .06s ease, box-shadow .15s ease, background .15s ease;
      box-shadow:0 10px 24px rgba(47,108,246,.34);
    }
    .primary:hover{ background:#2a5fe0; }
    .primary:active{ transform:translateY(1px); box-shadow:0 6px 16px rgba(47,108,246,.34); }
  </style>
</head>
<body class="auth">
  <main class="wrap">
    <div class="auth-card">
      <h2>Ingreso</h2>

      <div class="row">
        <input id="user" class="auth-input" placeholder="Usuario" autocomplete="username" />
        <input id="pass" class="auth-input" type="password" placeholder="Contraseña" autocomplete="current-password" />
        <button id="btn" class="primary" type="button">Entrar</button>
        <button id="btn-register" class="secondary" type="button">Crear cuenta</button>
      </div>
    </div>
  </main>

 <!-- Modal de registro (oculto por defecto) -->
<div id="reg-modal" class="modal hidden">
  <div class="modal-card">
    <h3>Crear cuenta</h3>

    <input id="reg-name"  class="auth-input" placeholder="Nombre" />
    <input id="reg-email" class="auth-input" placeholder="Correo" autocomplete="username" />
    <input id="reg-pass"  class="auth-input" type="password" placeholder="Contraseña" autocomplete="new-password" />
    <select id="reg-role" class="auth-input">
      <option value="student">Estudiante</option>
      <option value="prof">Profesor</option>
    </select>

    <div class="row right">
      <button id="reg-cancel" class="secondary">Cancelar</button>
      <button id="reg-submit" class="primary">Crear</button>
    </div>
  </div>
</div>

<script type="module">
  import { setSession } from './src/roles.js';

  const $  = (id)=>document.getElementById(id);
  const show = el => el.classList.remove('hidden');
  const hide = el => el.classList.add('hidden');

  // LOGIN
  $('btn').addEventListener('click', async () => {
    const email = $('user').value.trim();
    const password = $('pass').value.trim();
    let r, j;
    try {
      r = await fetch('/api/auth/login', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ email, password })
      });
      j = await r.json();
    } catch {
      alert('Error de red'); return;
    }
    if (!r.ok || !j.ok) return alert(j?.error || 'Login fallido');

    setSession(j.user);                          // <-- guardamos {id,name,email,role}
    location.replace(j.user.role === 'prof' ? 'encargado.html' : 'estudiante.html');
  });

  // Enter
  ['user','pass'].forEach(id=>{
    $(id).addEventListener('keydown', e => { if (e.key === 'Enter') $('btn').click(); });
  });

  // ABRIR / CERRAR MODAL REGISTRO
  $('btn-register').addEventListener('click', () => show($('reg-modal')));
  $('reg-cancel').addEventListener('click', () => hide($('reg-modal')));

  // SUBMIT REGISTRO
  $('reg-submit').addEventListener('click', async () => {
    const name  = $('reg-name').value.trim();
    const email = $('reg-email').value.trim();
    const password = $('reg-pass').value.trim();
    const role  = $('reg-role').value;

    if (!name || !email || !password) return alert('Completa todos los campos');

    let r, j;
    try {
      r = await fetch('/api/auth/register', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ name, email, password, role })
      });
      j = await r.json();
    } catch {
      alert('Error de red'); return;
    }
    if (!r.ok || !j.ok) return alert(j?.error || 'No se pudo registrar');

    setSession(j.user);
    location.replace(j.user.role === 'prof' ? 'encargado.html' : 'estudiante.html');
  });
</script>
